<div class="bg">
  <div class="container">
  <h2>Investment & Expense Tracker</h2>

  <!-- Tab Navigation -->
  <div class="tab-container">
    <button 
      class="tab-button"
      [class.active]="activeTab === 'investments'"
      (click)="switchTab('investments')">
      Investments
    </button>
    <button 
      class="tab-button"
      [class.active]="activeTab === 'expenses'"
      (click)="switchTab('expenses')">
      Expenses
    </button>
    <button 
      class="tab-button"
      [class.active]="activeTab === 'income'"
      (click)="switchTab('income')">
      Monthly Income
    </button>
    <button 
      class="tab-button"
      [class.active]="activeTab === 'budget'"
      (click)="switchTab('budget')">
      Monthly Budget
    </button>
  </div>

  <!-- Investment Tab -->
  <div *ngIf="activeTab === 'investments'">
    <form (ngSubmit)="addInvestment()" class="investment-form">
      <div class="form-row">
        <div class="form-group">
          <label>Investment Type:</label>
          <select [(ngModel)]="newInvestment.type" name="type" required>
            <option *ngFor="let type of investmentTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>
            Amount (‚Çπ):
            <span *ngIf="newInvestment.type === 'PPF'" class="hint">- Monthly amount</span>
            <span *ngIf="newInvestment.type === 'RD'" class="hint">- Monthly amount</span>
            <span *ngIf="newInvestment.type === 'FD'" class="hint">- One-time amount</span>
            <span *ngIf="newInvestment.type === 'Savings'" class="hint">- One-time amount</span>
          </label>
          <input
            type="number"
            [(ngModel)]="newInvestment.amount"
            name="amount"
            required
            min="1"
          />
        </div>
        <div class="form-group" *ngIf="newInvestment.type !== 'Savings'">
          <label>Start Date:</label>
          <input
            type="date"
            [(ngModel)]="newInvestment.startDate"
            name="startDate"
            required
          />
        </div>
      </div>
      <div class="form-row" *ngIf="newInvestment.type !== 'Savings'">
        <div class="form-group" *ngIf="newInvestment.type !== 'PPF'">
          <label>Duration (Months):</label>
          <input
            type="number"
            [(ngModel)]="newInvestment.durationMonths"
            name="durationMonths"
            required
            min="1"
          />
        </div>
        <div class="form-group" *ngIf="newInvestment.type === 'PPF'">
          <label>Duration:</label>
          <input
            type="text"
            value="15 Years (Fixed)"
            readonly
            style="background-color: #f5f5f5"
          />
        </div>
        <div class="form-group">
          <label>Interest Rate (% per annum):</label>
          <input
            type="number"
            [(ngModel)]="newInvestment.interestRate"
            name="interestRate"
            required
            min="0"
            max="50"
            step="0.1"
          />
        </div>
      </div>

      <div class="btn-cnt">
        <button class="addbutton" type="submit">Add Investment</button>
        <button type="button" (click)="clearAllInvestments()" class="clear-btn">Clear All Investments</button>
        <button type="button" (click)="manuallyGenerateInvestmentExpenses()" class="auto-expense-btn">
          Generate Auto Expenses
        </button>
      </div>

      <!-- Auto-generated expenses info -->
      <div *ngIf="hasAutoGeneratedExpenses()" class="auto-expenses-info">
        <h4>üìÖ Auto-Generated Investment Expenses</h4>
        <p class="info-text">
          <i class="info-icon">‚ÑπÔ∏è</i>
          Monthly investment expenses are automatically generated based on your RD and PPF investments.
          These appear in your expense list with "Auto:" prefix.
        </p>
        <div class="auto-expense-summary">
          <div class="summary-item">
            <span class="label">Auto Expenses This Month:</span>
            <span class="value">‚Çπ{{ getAutoExpensesForCurrentMonth() | number : "1.0-0" }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Total Auto Expenses:</span>
            <span class="value">‚Çπ{{ getTotalAutoExpenses() | number : "1.0-0" }}</span>
          </div>
        </div>
      </div>
    </form>

    <!-- Investment Chart -->
    <div class="chart-container" *ngIf="investments.length > 0">
      <h3 class="txt-clr">Investment Portfolio Distribution (Maturity Values)</h3>
      <canvas
        baseChart
        [data]="pieChartData"
        [type]="chartType"
        style="max-height: 400px">
      </canvas>
    </div>

    <!-- Investment Summary Table -->
    <div *ngIf="investments.length > 0">
      <h3>Investment Summary</h3>
      <div class="table-responsive">
    <table border="1" cellpadding="8">
      <thead>
        <tr>
          <th>S.No</th>
          <th>Investment Type</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Investment Amount</th>
          <th>Current Value</th>
          <th>Maturity Value</th>
          <th>Interest Rate (%)</th>
          <th>Invested So Far</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let inv of investments; let i = index" [class.editing-row]="isEditingInvestment(i)">
          <td>{{ i + 1 }}</td>
          
          <!-- Investment Type -->
          <td>
            <select 
              *ngIf="isEditingInvestment(i); else showType"
              [(ngModel)]="editingInvestment.type"
              name="editType"
              class="edit-select">
              <option *ngFor="let type of getInvestmentTypes()" [value]="type">
                {{ type }}
              </option>
            </select>
            <ng-template #showType>{{ inv.type }}</ng-template>
          </td>
          
          <!-- Start Date -->
          <td>
            <input 
              *ngIf="isEditingInvestment(i); else showStartDate"
              type="date"
              [(ngModel)]="editingInvestment.startDate"
              name="editStartDate"
              class="edit-input">
            <ng-template #showStartDate>{{ inv.startDate | date : "dd/MM/yyyy" }}</ng-template>
          </td>
          
          <!-- End Date -->
          <td>{{ getEndDateDisplay(inv) }}</td>
          
          <!-- Investment Amount -->
          <td>
            <div *ngIf="isEditingInvestment(i); else showAmount">
              <input 
                type="number"
                [(ngModel)]="editingInvestment.amount"
                name="editAmount"
                class="edit-input"
                min="1"
                required>
            </div>
            <ng-template #showAmount>
              {{ getAmountDisplay(inv) }}
              <div *ngIf="hasMonthlyBreakdown(inv)" class="monthly-breakdown">
                <small><strong>Monthly Investments:</strong></small>
                <div class="breakdown-list">
                  <small *ngFor="let month of getMonthlyBreakdown(inv)">{{ month }}</small>
                </div>
              </div>
            </ng-template>
          </td>
          
          <!-- Current Value -->
          <td class="currency">
            ‚Çπ{{ getMaturityAndCurrentValue(inv).currentValue | number : "1.0-0" }}
          </td>
          
          <!-- Maturity Value -->
          <td class="currency">
            ‚Çπ{{ getMaturityAndCurrentValue(inv).maturityValue | number : "1.0-0" }}
          </td>
          
          <!-- Interest Rate -->
          <td>
            <input 
              *ngIf="isEditingInvestment(i); else showRate"
              type="number"
              [(ngModel)]="editingInvestment.interestRate"
              name="editRate"
              class="edit-input"
              min="0"
              max="50"
              step="0.1">
            <ng-template #showRate>{{ inv.interestRate }}%</ng-template>
          </td>
          
          <!-- Invested So Far -->
          <td class="currency">
            ‚Çπ{{ getMaturityAndCurrentValue(inv).investedSoFar | number : "1.0-0" }}
          </td>
          
          <!-- Actions Column -->
          <td class="actions-column">
            <!-- Edit Mode Actions -->
            <div *ngIf="isEditingInvestment(i)" class="edit-actions">
              <button class="save-btn" (click)="saveEditInvestment()" title="Save Changes">
                üíæ Save
              </button>
              <button class="cancel-btn" (click)="cancelEditInvestment()" title="Cancel Edit">
                ‚ùå Cancel
              </button>
              
              <!-- Duration field for edit mode -->
              <div class="duration-edit" *ngIf="editingInvestment.type !== 'Savings'">
                <label>Duration:</label>
                <input 
                  *ngIf="isDurationEditable(editingInvestment.type); else showFixedDuration"
                  type="number"
                  [(ngModel)]="editingInvestment.durationMonths"
                  name="editDuration"
                  class="edit-input small"
                  min="1">
                <ng-template #showFixedDuration>
                  <input 
                    type="text"
                    value="15 Years (Fixed)"
                    readonly
                    class="edit-input readonly">
                </ng-template>
              </div>
            </div>
            
            <!-- Normal Mode Actions -->
            <div *ngIf="!isEditingInvestment(i)" class="normal-actions">
              <button 
                class="edit-btn" 
                (click)="startEditInvestment(i)"
                title="Edit Investment">
                 Edit
              </button>
              <button 
                class="delete-btn" 
                (click)="deleteInvestment(i)"
                title="Delete Investment">
                 Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
      <div class="summary-section">
        <h4>Total Invested by Type</h4>
        <ul class="summary-list">
          <li *ngFor="let key of objectKeys(totalByType)">
            <strong>{{ key }}:</strong> ‚Çπ{{ totalByType[key] | number : "1.0-0" }}
          </li>
        </ul>
        <div class="totals">
          <h4>Portfolio Summary</h4>
          <div class="total-item">
            <strong>Total Invested So Far:</strong>
            ‚Çπ{{ getTotalInvested() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total Current Value:</strong>
            ‚Çπ{{ getTotalCurrentValue() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total Maturity Value:</strong>
            ‚Çπ{{ getTotalMaturityValue() | number : "1.0-0" }}
          </div>
          <div class="total-item d_blue">
            <strong>Total Savings:</strong>
            ‚Çπ{{ getTotalSavings() | number : "1.0-0" }}
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="investments.length === 0" class="no-investments">
      <p>No investments added yet. Add your first investment using the form above.</p>
    </div>
  </div>

  <!-- Expense Tab -->
  <div *ngIf="activeTab === 'expenses'">
    <form (ngSubmit)="addExpense()" class="expense-form">
      <div class="form-row">
        <div class="form-group">
          <label>Expense Category:</label>
          <select [(ngModel)]="newExpense.category" name="category" required>
            <option *ngFor="let category of expenseCategories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Description:</label>
          <input
            type="text"
            [(ngModel)]="newExpense.description"
            name="description"
            required
            placeholder="Enter expense description"
          />
        </div>
        <div class="form-group">
          <label>Amount (‚Çπ):</label>
          <input
            type="number"
            [(ngModel)]="newExpense.amount"
            name="expenseAmount"
            required
            min="1"
          />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date:</label>
          <input
            type="date"
            [(ngModel)]="newExpense.date"
            name="expenseDate"
            required
          />
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select [(ngModel)]="newExpense.type" name="expenseType" required>
            <option value="one-time">One-time</option>
            <option value="monthly">Monthly Recurring</option>
          </select>
        </div>
        <!-- NEW: Payment Method -->
        <div class="form-group">
          <label>Payment Method:</label>
          <select [(ngModel)]="newExpense.paymentMethod" name="paymentMethod" required>
            <option value="cash">üíµ Cash</option>
            <option value="account">üè¶ Account</option>
          </select>
          <small class="payment-hint">
            <span *ngIf="newExpense.paymentMethod === 'cash'" class="cash-hint">
              üí° Cash payments don't affect your account balance
            </span>
            <span *ngIf="newExpense.paymentMethod === 'account'" class="account-hint">
              üí° Account payments will reduce your monthly income
            </span>
          </small>
        </div>
      </div>
      <div class="btn-cnt">
        <button class="expense-btn" type="submit">Add Expense</button>
        <button type="button" (click)="clearAllExpenses()" class="clear-btn">Clear All Expenses</button>
      </div>
    </form>

    <!-- Filter Toggle Button -->
    <div class="filter-toggle-section">
      <button class="filter-toggle-btn" (click)="toggleFilters()">
        <i class="filter-icon">üîç</i>
        <span>Filter Expenses</span>
        <i class="toggle-icon">{{ showFilters ? '‚ñ≤' : '‚ñº' }}</i>
      </button>
    </div>

    <!-- Collapsible Filter Section -->
    <div class="filter-section" [class.expanded]="showFilters" *ngIf="showFilters">
      <div class="filter-header">
        <h3>Filter Expenses</h3>
        <button class="clear-filters-btn" (click)="clearFilters()">
          <i>‚úï</i> Clear Filters
        </button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Select Month:</label>
          <input
            type="month"
            [(ngModel)]="expenseFilterMonth"
            name="expenseFilterMonth"
            (ngModelChange)="filterExpensesByMonth()"
          />
        </div>
        <div class="form-group">
          <label>Filter by Category:</label>
          <select [(ngModel)]="expenseFilterCategory" name="expenseFilterCategory" (ngModelChange)="filterExpensesByMonth()">
            <option value="">All Categories</option>
            <option *ngFor="let category of expenseCategories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Filter by Type:</label>
          <select [(ngModel)]="expenseFilterType" name="expenseFilterType" (ngModelChange)="filterExpensesByMonth()">
            <option value="">All Types</option>
            <option value="monthly">Monthly</option>
            <option value="one-time">One-time</option>
          </select>
        </div>
        <!-- NEW: Payment Method Filter -->
        <div class="form-group">
          <label>Filter by Payment:</label>
          <select [(ngModel)]="expenseFilterPayment" name="expenseFilterPayment" (ngModelChange)="filterExpensesByMonth()">
            <option value="">All Payments</option>
            <option value="cash">Cash</option>
            <option value="account">Account</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Filtered Expense Summary -->
    <div *ngIf="showFilters && filteredExpenses.length > 0" class="filtered-results">
      <div class="filtered-header">
        <h3>
          Expense Details for {{ getMonthDisplay(expenseFilterMonth) }}
          <span *ngIf="expenseFilterCategory" class="filter-tag">{{ expenseFilterCategory }}</span>
          <span *ngIf="expenseFilterType" class="filter-tag">{{ expenseFilterType === 'monthly' ? 'Monthly' : 'One-time' }}</span>
          <span *ngIf="expenseFilterPayment" class="filter-tag payment-tag">{{ expenseFilterPayment === 'cash' ? 'üíµ Cash' : 'üè¶ Account' }}</span>
        </h3>
      </div>
      
      <div class="expense-stats">
        <div class="stat-item">
          <span class="stat-label">Total Filtered Expenses:</span>
          <span class="stat-value">‚Çπ{{ getFilteredExpenseTotal() | number : "1.0-0" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Cash Expenses:</span>
          <span class="stat-value cash">‚Çπ{{ getFilteredCashExpenses() | number : "1.0-0" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Account Expenses:</span>
          <span class="stat-value account">‚Çπ{{ getFilteredAccountExpenses() | number : "1.0-0" }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Number of Transactions:</span>
          <span class="stat-value">{{ filteredExpenses.length }}</span>
        </div>
      </div>

      <div class="table-responsive">
        <table border="1" cellpadding="8">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Type</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let expense of filteredExpenses; let i = index" [class.cash-payment]="expense.paymentMethod === 'cash'" [class.account-payment]="expense.paymentMethod === 'account'">
              <td>{{ i + 1 }}</td>
              <td>{{ expense.category }}</td>
              <td>{{ expense.description }}</td>
              <td class="currency">‚Çπ{{ expense.amount | number : "1.0-0" }}</td>
              <td>{{ expense.date | date : "dd/MM/yyyy" }}</td>
              <td>
                <span class="expense-type" [class]="expense.type">
                  {{ expense.type === 'monthly' ? 'Monthly' : 'One-time' }}
                </span>
              </td>
              <td>
                <span class="payment-method" [class]="expense.paymentMethod">
                  {{ expense.paymentMethod === 'cash' ? 'üíµ Cash' : 'üè¶ Account' }}
                </span>
              </td>
              <td>
                <button class="delete-btn" (click)="deleteExpense(expense.id)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Category wise breakdown for filtered data -->
      <div class="summary-section" *ngIf="filteredExpensesByCategory && objectKeys(filteredExpensesByCategory).length > 0">
        <h4>Category-wise Breakdown (Filtered)</h4>
        <div class="category-breakdown">
          <div class="category-item" *ngFor="let key of objectKeys(filteredExpensesByCategory)">
            <span class="category-name">{{ key }}:</span>
            <span class="category-amount">‚Çπ{{ filteredExpensesByCategory[key] | number : "1.0-0" }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- All Expenses Summary -->
    <div *ngIf="expenses.length > 0" class="all-expenses-section">
      <h3>All Expenses Summary</h3>
      
      <!-- Payment Method Overview -->
      <div class="payment-overview">
        <div class="payment-summary-grid">
          <div class="payment-summary-item cash">
            <h5>üíµ Total Cash Expenses</h5>
            <span class="amount">‚Çπ{{ getTotalCashExpenses() | number : "1.0-0" }}</span>
            <small>{{ getCashExpenseCount() }} transactions</small>
          </div>
          <div class="payment-summary-item account">
            <h5>üè¶ Total Account Expenses</h5>
            <span class="amount">‚Çπ{{ getTotalAccountExpenses() | number : "1.0-0" }}</span>
            <small>{{ getAccountExpenseCount() }} transactions</small>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table border="1" cellpadding="8">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Type</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let expense of currentMonthExpenses; let i = index" [class.cash-payment]="expense.paymentMethod === 'cash'" [class.account-payment]="expense.paymentMethod === 'account'">
              <td>{{ i + 1 }}</td>
              <td>{{ expense.category }}</td>
              <td>{{ expense.description }}</td>
              <td class="currency">‚Çπ{{ expense.amount | number : "1.0-0" }}</td>
              <td>{{ expense.date | date : "dd/MM/yyyy" }}</td>
              <td>
                <span class="expense-type" [class]="expense.type">
                  {{ expense.type === 'monthly' ? 'Monthly' : 'One-time' }}
                </span>
              </td>
              <td>
                <span class="payment-method" [class]="expense.paymentMethod">
                  {{ expense.paymentMethod === 'cash' ? 'üíµ Cash' : 'üè¶ Account' }}
                </span>
              </td>
              <td>
                <button class="delete-btn" (click)="deleteExpense(expense.id)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="summary-section">
        <h4>Expense Summary by Category</h4>
        <div class="category-breakdown">
          <div class="category-item" *ngFor="let key of objectKeys(expensesByCategoryThisMonth)">
            <span class="category-name">{{ key }}:</span>
            <span class="category-amount">‚Çπ{{ expensesByCategoryThisMonth[key] | number : "1.0-0" }}</span>
          </div>
        </div>
        <div class="totals">
          <h4>Total Expenses</h4>
          <!-- <div class="total-item">
            <strong>Total Cash Expenses:</strong>
            ‚Çπ{{ getTotalCashExpenses() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total Account Expenses:</strong>
            ‚Çπ{{ getTotalAccountExpenses() | number : "1.0-0" }}
          </div> -->
          <div class="total-item">
            <strong>Total One-time Expenses:</strong>
            ‚Çπ{{ getTotalOneTimeExpenses() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total Monthly Expenses:</strong>
            ‚Çπ{{ getTotalMonthlyExpenses() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong class="red">Total All Expenses:</strong>
            ‚Çπ{{ getTotalExpenses() | number : "1.0-0" }}
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="expenses.length === 0" class="no-investments">
      <p>No expenses added yet. Add your first expense using the form above.</p>
    </div>
  </div>

  <!-- Monthly Income Tab -->
  <div *ngIf="activeTab === 'income'">
    <form (ngSubmit)="addIncome()" class="income-form">
      <div class="form-row">
        <div class="form-group">
          <label>Income Source:</label>
          <select [(ngModel)]="newIncome.source" name="source" required>
            <option *ngFor="let source of incomeSources" [value]="source">
              {{ source }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>Description:</label>
          <input
            type="text"
            [(ngModel)]="newIncome.description"
            name="incomeDescription"
            required
            placeholder="Enter income description"
          />
        </div>
        <div class="form-group">
          <label>Amount (‚Çπ):</label>
          <input
            type="number"
            [(ngModel)]="newIncome.amount"
            name="incomeAmount"
            required
            min="1"
          />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date:</label>
          <input
            type="date"
            [(ngModel)]="newIncome.date"
            name="incomeDate"
            required
          />
        </div>
        <div class="form-group">
          <label>Type:</label>
          <select [(ngModel)]="newIncome.type" name="incomeType" required>
            <option value="monthly">Monthly Salary</option>
            <option value="one-time">One-time Income</option>
          </select>
        </div>
      </div>
      <div class="btn-cnt">
        <button class="income-btn" type="submit">Add Income</button>
        <button type="button" (click)="clearAllIncomes()" class="clear-btn">Clear All Incomes</button>
      </div>
    </form>

    <!-- Income Summary -->
    <div *ngIf="incomes.length > 0">
      <h3>Income Summary</h3>
      <div class="table-responsive">
        <table border="1" cellpadding="8">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Source</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let income of incomes; let i = index">
              <td>{{ i + 1 }}</td>
              <td>{{ income.source }}</td>
              <td>{{ income.description }}</td>
              <td class="currency income-amount">‚Çπ{{ income.amount | number : "1.0-0" }}</td>
              <td>{{ income.date | date : "dd/MM/yyyy" }}</td>
              <td>
                <span class="income-type" [class]="income.type">
                  {{ income.type === 'monthly' ? 'Monthly' : 'One-time' }}
                </span>
              </td>
              <td>
                <button class="delete-btn" (click)="deleteIncome(income.id)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="summary-section">
        <h4>Income Summary by Source</h4>
        <div class="category-breakdown">
          <div class="category-item" *ngFor="let key of objectKeys(incomesBySource)">
            <span class="category-name">{{ key }}:</span>
            <span class="category-amount">‚Çπ{{ incomesBySource[key] | number : "1.0-0" }}</span>
          </div>
        </div>
        <div class="totals">
          <h4>Total Income</h4>
          <div class="total-item">
            <strong>Total Monthly Income:</strong>
            ‚Çπ{{ getTotalMonthlyIncome() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total One-time Income:</strong>
            ‚Çπ{{ getTotalOneTimeIncome() | number : "1.0-0" }}
          </div>
          <div class="total-item">
            <strong>Total All Income:</strong>
            ‚Çπ{{ getTotalIncome() | number : "1.0-0" }}
          </div>
          <div class="total-item account-deduction">
            <strong>Account Deductions (Expenses):</strong>
            -‚Çπ{{ getTotalAccountExpenses() | number : "1.0-0" }}
          </div>
          <div class="total-item net-income">
            <strong>Net Account Balance:</strong>
            ‚Çπ{{ getNetAccountBalance() | number : "1.0-0" }}
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="incomes.length === 0" class="no-investments">
      <p>No income entries added yet. Add your first income using the form above.</p>
    </div>
  </div>

  <!-- Budget Tab with Enhanced Savings -->
  <div *ngIf="activeTab === 'budget'">
    <div class="budget-form">
      <h3>Monthly Budget Overview</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label>Select Month:</label>
          <input
            type="month"
            [(ngModel)]="selectedMonth"
            name="selectedMonth"
            (ngModelChange)="updateBudgetSummary()"
          />
        </div>
      </div>

      <div class="budget-summary">
        <h4>Budget Summary for {{ getMonthDisplay(selectedMonth) }}</h4>
        
        <div class="budget-grid">
          <div class="budget-item income">
            <h5>Monthly Income</h5>
            <span class="amount">‚Çπ{{ getMonthlyIncomeForMonth(selectedMonth) | number : "1.0-0" }}</span>
          </div>
          <div class="budget-item expenses">
            <h5>Total Monthly Expenses</h5>
            <span class="amount">‚Çπ{{ getMonthlyExpensesForMonth(selectedMonth) | number : "1.0-0" }}</span>
          </div>
          <div class="budget-item account-expenses">
            <h5>Account Expenses Only</h5>
            <span class="amount">‚Çπ{{ getMonthlyAccountExpensesForMonth(selectedMonth) | number : "1.0-0" }}</span>
          </div>
          <div class="budget-item cash-expenses">
            <h5>Cash Expenses Only</h5>
            <span class="amount">‚Çπ{{ getMonthlyCashExpensesForMonth(selectedMonth) | number : "1.0-0" }}</span>
          </div>
          <div class="budget-item investments">
            <h5>Monthly Investments</h5>
            <span class="amount">‚Çπ{{ getMonthlyInvestmentsForMonth(selectedMonth) | number : "1.0-0" }}</span>
          </div>
          <div class="budget-item remaining" [class.negative]="getRemainingAmount() < 0">
            <h5>Net Available (Income - Account Expenses)</h5>
            <span class="amount">‚Çπ{{ getNetAvailableAmount() | number : "1.0-0" }}</span>
          </div>
        </div>

        <!-- Enhanced Payment Method Breakdown -->
        <div class="payment-breakdown">
          <h4>üí∞ Payment Method Analysis</h4>
          <div class="payment-analysis-grid">
            <div class="analysis-card cash-card">
              <h5>üíµ Cash Flow</h5>
              <div class="flow-details">
                <div class="flow-item">
                  <span class="label">Cash Expenses:</span>
                  <span class="value">‚Çπ{{ getMonthlyCashExpensesForMonth(selectedMonth) | number : "1.0-0" }}</span>
                </div>
                <div class="flow-note">
                  <small>üí° Cash expenses don't affect your account balance</small>
                </div>
              </div>
            </div>
            
            <div class="analysis-card account-card">
              <h5>üè¶ Account Flow</h5>
              <div class="flow-details">
                <div class="flow-item">
                  <span class="label">Income:</span>
                  <span class="value positive">+‚Çπ{{ getMonthlyIncomeForMonth(selectedMonth) | number : "1.0-0" }}</span>
                </div>
                <div class="flow-item">
                  <span class="label">Account Expenses:</span>
                  <span class="value negative">-‚Çπ{{ getMonthlyAccountExpensesForMonth(selectedMonth) | number : "1.0-0" }}</span>
                </div>
                <div class="flow-item total">
                  <span class="label">Net Balance:</span>
                  <span class="value" [class.negative]="getNetAvailableAmount() < 0">‚Çπ{{ getNetAvailableAmount() | number : "1.0-0" }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- NEW: Enhanced Savings Section -->
        <div class="savings-overview">
          <h4>üí∞ Savings Overview</h4>
          
          <div class="savings-grid">
            <div class="savings-item initial">
              <h5>Initial Savings</h5>
              <span class="amount">‚Çπ{{ savingsDisplay.initial | number : "1.0-0" }}</span>
              <small>Base savings amount</small>
            </div>
            
            <div class="savings-item monthly">
              <h5>This Month's Addition</h5>
              <span class="amount">‚Çπ{{ getCurrentMonthSavings() | number : "1.0-0" }}</span>
              <small>Auto-saved from remaining</small>
            </div>
            
            <div class="savings-item total">
              <h5>Total Savings</h5>
              <span class="amount total-amount">‚Çπ{{ getTotalSavings() | number : "1.0-0" }}</span>
              <small>Initial + Monthly Additions</small>
            </div>
          </div>

          <!-- Manual Save Button -->
          <div class="savings-actions">
            <button 
              class="save-remaining-btn" 
              (click)="addRemainingToSavings()"
              [disabled]="getNetAvailableAmount() <= 0">
              <span *ngIf="getNetAvailableAmount() > 0">üíæ Save ‚Çπ{{ getNetAvailableAmount() | number : "1.0-0" }} to Savings</span>
              <span *ngIf="getNetAvailableAmount() <= 0">üí∏ No Net Surplus to Save</span>
            </button>
          </div>

          <!-- Savings History for Current Month -->
          <div class="savings-history" *ngIf="savingsHistory.length > 0">
            <h5>üìà Recent Savings History</h5>
            <div class="history-list">
              <div 
                class="history-item" 
                *ngFor="let entry of savingsHistory.slice().reverse().slice(0, 5)"
                [class.current-month]="entry.month === selectedMonth">
                <div class="history-info">
                  <span class="month-name">{{ getMonthDisplay(entry.month) }}</span>
                  <span class="entry-source">From net available amount</span>
                </div>
                <div class="history-amount">
                  <span class="amount-value">+‚Çπ{{ entry.amount | number : "1.0-0" }}</span>
                  <span class="auto-label" *ngIf="entry.month === selectedMonth">Current</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Budget Distribution Chart -->
        <div class="budget-chart" *ngIf="budgetChartData.datasets[0].data.length > 0">
          <h4>Budget Distribution</h4>
          <canvas
            baseChart
            [data]="budgetChartData"
            [type]="'pie'"
            style="max-height: 300px">
          </canvas>
        </div>

        <!-- Budget Analytics -->
        <div class="budget-analytics">
          <h4>üìä Budget Analytics</h4>
          
          <div class="analytics-grid">
            <div class="analytics-item expense-ratio">
              <h6>Total Expense Ratio</h6>
              <div class="ratio-value">
                {{ ((getMonthlyExpensesForMonth(selectedMonth) / getMonthlyIncomeForMonth(selectedMonth)) * 100) | number : "1.0-0" }}%
              </div>
              <small>of total income</small>
            </div>
            
            <div class="analytics-item account-ratio">
              <h6>Account Expense Ratio</h6>
              <div class="ratio-value">
                {{ ((getMonthlyAccountExpensesForMonth(selectedMonth) / getMonthlyIncomeForMonth(selectedMonth)) * 100) | number : "1.0-0" }}%
              </div>
              <small>of total income</small>
            </div>
            
            <div class="analytics-item investment-ratio">
              <h6>Investment Ratio</h6>
              <div class="ratio-value">
                {{ ((getMonthlyInvestmentsForMonth(selectedMonth) / getMonthlyIncomeForMonth(selectedMonth)) * 100) | number : "1.0-0" }}%
              </div>
              <small>of total income</small>
            </div>
            
            <div class="analytics-item savings-ratio">
              <h6>Net Savings Ratio</h6>
              <div class="ratio-value" [class.negative]="getNetAvailableAmount() < 0">
                {{ ((getNetAvailableAmount() / getMonthlyIncomeForMonth(selectedMonth)) * 100) | number : "1.0-0" }}%
              </div>
              <small>of total income</small>
            </div>
            
            <div class="analytics-item financial-health">
              <h6>Financial Health</h6>
              <div class="health-indicator">
                <span 
                  class="health-status"
                  [class.excellent]="getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.2"
                  [class.good]="getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.1 && getNetAvailableAmount() < getMonthlyIncomeForMonth(selectedMonth) * 0.2"
                  [class.average]="getNetAvailableAmount() >= 0 && getNetAvailableAmount() < getMonthlyIncomeForMonth(selectedMonth) * 0.1"
                  [class.poor]="getNetAvailableAmount() < 0">
                  {{ 
                    getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.2 ? 'Excellent' :
                    getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.1 ? 'Good' :
                    getNetAvailableAmount() >= 0 ? 'Average' : 'Poor'
                  }}
                </span>
              </div>
              <small>
                {{ 
                  getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.2 ? 'Great savings rate!' :
                  getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.1 ? 'Good financial discipline' :
                  getNetAvailableAmount() >= 0 ? 'Room for improvement' : 'Account deficit'
                }}
              </small>
            </div>
          </div>
        </div>

        <!-- Financial Tips -->
        <div class="financial-tips">
          <h4>üí° Financial Tips</h4>
          <div class="tips-container">
            <div class="tip-item" *ngIf="getNetAvailableAmount() < 0">
              <span class="tip-icon">‚ö†Ô∏è</span>
              <span class="tip-text">Your account expenses exceed income. Consider reducing account-based expenses or using more cash payments.</span>
            </div>
            <div class="tip-item" *ngIf="getMonthlyCashExpensesForMonth(selectedMonth) > getMonthlyAccountExpensesForMonth(selectedMonth)">
              <span class="tip-icon">üíµ</span>
              <span class="tip-text">Good cash flow management! You're using more cash than account payments.</span>
            </div>
            <div class="tip-item" *ngIf="getNetAvailableAmount() >= 0 && getNetAvailableAmount() < getMonthlyIncomeForMonth(selectedMonth) * 0.1">
              <span class="tip-icon">üìà</span>
              <span class="tip-text">Try to save at least 10% of your income for better financial security.</span>
            </div>
            <div class="tip-item" *ngIf="getNetAvailableAmount() >= getMonthlyIncomeForMonth(selectedMonth) * 0.2">
              <span class="tip-icon">üéØ</span>
              <span class="tip-text">Excellent savings rate! Consider investing the surplus in long-term instruments.</span>
            </div>
            <div class="tip-item" *ngIf="getMonthlyInvestmentsForMonth(selectedMonth) < getMonthlyIncomeForMonth(selectedMonth) * 0.1">
              <span class="tip-icon">üí∞</span>
              <span class="tip-text">Consider investing at least 10% of your income for wealth building.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auto-Savings Information -->
    <div class="auto-savings-info">
      <h4>ü§ñ Auto-Savings Information</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-icon">‚ö°</span>
          <div class="info-content">
            <strong>Automatic Savings</strong>
            <p>Your net available amount (income minus account expenses) is automatically added to savings when you change income or expenses.</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">üîÑ</span>
          <div class="info-content">
            <strong>Real-time Updates</strong>
            <p>Total savings update instantly as your budget changes throughout the month.</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">üìä</span>
          <div class="info-content">
            <strong>Smart Calculation</strong>
            <p>Only account-based expenses reduce your available balance. Cash expenses are tracked separately.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>